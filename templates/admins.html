{% extends "base.html" %}

{% block title %}Управление админами - Bot Creator Admin{% endblock %}
{% block page_title %}Управление админами{% endblock %}

{% block content %}
<!-- Current Admins -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-shield me-2"></i>
                    Текущие администраторы
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Telegram ID</th>
                                <th>Имя пользователя</th>
                                <th>Имя</th>
                                <th>Статус</th>
                                <th>Добавлен</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for admin in admins %}
                            <tr class="table-row-animated">
                                <td>{{ admin.id }}</td>
                                <td>
                                    <code>{{ admin.telegram_id }}</code>
                                </td>
                                <td>
                                    {% if admin.username %}
                                        @{{ admin.username }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ admin.first_name }}
                                    {% if admin.last_name %}
                                        {{ admin.last_name }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-crown me-1"></i>
                                        Админ
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ admin.created_at[:10] }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="viewAdmin({{ admin.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="removeAdmin({{ admin.telegram_id }})">
                                            <i class="fas fa-user-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add New Admin -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    Добавить администратора
                </h5>
            </div>
            <div class="card-body">
                <form id="addAdminForm">
                    <div class="mb-3">
                        <label for="telegramId" class="form-label">Telegram ID</label>
                        <input type="number" class="form-control" id="telegramId" placeholder="1704897414" required>
                        <div class="form-text">Введите Telegram ID пользователя</div>
                    </div>
                    <div class="mb-3">
                        <label for="adminName" class="form-label">Имя (опционально)</label>
                        <input type="text" class="form-control" id="adminName" placeholder="Илья">
                    </div>
                    <div class="mb-3">
                        <label for="adminUsername" class="form-label">Username (опционально)</label>
                        <input type="text" class="form-control" id="adminUsername" placeholder="@ilya_ttr">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-user-plus me-2"></i>
                        Добавить администратора
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Информация
                </h5>
            </div>
            <div class="card-body">
                <h6>Права администратора:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i>Доступ к админ-панели</li>
                    <li><i class="fas fa-check text-success me-2"></i>Управление пользователями</li>
                    <li><i class="fas fa-check text-success me-2"></i>Просмотр всех ботов</li>
                    <li><i class="fas fa-check text-success me-2"></i>Мониторинг генераций</li>
                    <li><i class="fas fa-check text-success me-2"></i>Статистика и аналитика</li>
                    <li><i class="fas fa-check text-success me-2"></i>Premium статус автоматически</li>
                </ul>
                
                <hr>
                
                <h6>Рекомендуемые админы:</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="addRecommendedAdmin(1704897414, 'Илья', '@ilya_ttr')">
                        <i class="fas fa-user me-2"></i>
                        ID: 1704897414 (@ilya_ttr)
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="addRecommendedAdmin(6491802621, 'Илья', '@ilya_ttr')">
                        <i class="fas fa-user me-2"></i>
                        ID: 6491802621 (Илья)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Activity Log -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Журнал активности админов
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Время</th>
                                <th>Админ</th>
                                <th>Действие</th>
                                <th>Детали</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-row-animated">
                                <td>
                                    <small class="text-muted">28.09.2024 18:00</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">ID: 1704897414</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">Добавлен</span>
                                </td>
                                <td>
                                    <small>Новый администратор добавлен в систему</small>
                                </td>
                            </tr>
                            <tr class="table-row-animated">
                                <td>
                                    <small class="text-muted">28.09.2024 17:30</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">ID: 6491802621</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">Просмотр</span>
                                </td>
                                <td>
                                    <small>Просмотр статистики пользователей</small>
                                </td>
                            </tr>
                            <tr class="table-row-animated">
                                <td>
                                    <small class="text-muted">28.09.2024 17:00</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">ID: 1704897414</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning">Изменение</span>
                                </td>
                                <td>
                                    <small>Обновлен статус пользователя ID: 123456789</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Details Modal -->
<div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали администратора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="adminModalBody">
                <!-- Содержимое будет загружено динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-danger" onclick="removeAdmin()">Удалить админа</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Добавление администратора
document.getElementById('addAdminForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const telegramId = document.getElementById('telegramId').value;
    const adminName = document.getElementById('adminName').value;
    const adminUsername = document.getElementById('adminUsername').value;
    
    try {
        const response = await fetch('/api/admins/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ telegram_id: parseInt(telegramId) })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Администратор успешно добавлен!', 'success');
            location.reload();
        } else {
            showNotification('Ошибка при добавлении администратора', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Ошибка при добавлении администратора', 'error');
    }
});

// Добавление рекомендуемого админа
function addRecommendedAdmin(telegramId, name, username) {
    document.getElementById('telegramId').value = telegramId;
    document.getElementById('adminName').value = name;
    document.getElementById('adminUsername').value = username;
}

// Удаление администратора
async function removeAdmin(telegramId) {
    if (!telegramId) {
        telegramId = prompt('Введите Telegram ID администратора для удаления:');
        if (!telegramId) return;
    }
    
    if (confirm(`Вы уверены, что хотите удалить администратора ${telegramId}?`)) {
        try {
            const response = await fetch('/api/admins/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ telegram_id: parseInt(telegramId) })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Администратор успешно удален!', 'success');
                location.reload();
            } else {
                showNotification('Ошибка при удалении администратора', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Ошибка при удалении администратора', 'error');
        }
    }
}

// Просмотр деталей админа
function viewAdmin(adminId) {
    document.getElementById('adminModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('adminModal'));
    modal.show();
    
    // Имитация загрузки данных
    setTimeout(() => {
        document.getElementById('adminModalBody').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Основная информация</h6>
                    <p><strong>ID:</strong> ${adminId}</p>
                    <p><strong>Telegram ID:</strong> 1704897414</p>
                    <p><strong>Имя пользователя:</strong> @ilya_ttr</p>
                    <p><strong>Имя:</strong> Илья</p>
                </div>
                <div class="col-md-6">
                    <h6>Статистика</h6>
                    <p><strong>Статус:</strong> <span class="badge bg-success">Активен</span></p>
                    <p><strong>Добавлен:</strong> 28.09.2024</p>
                    <p><strong>Последняя активность:</strong> 28.09.2024 18:00</p>
                    <p><strong>Действий выполнено:</strong> 15</p>
                </div>
            </div>
        `;
    }, 1000);
}

// Показ уведомлений
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматическое удаление через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}
